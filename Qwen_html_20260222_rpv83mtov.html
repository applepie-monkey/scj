<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç·šé›»é˜»å¯¦é©—æ¢ç©¶ç³»çµ± | æ•¸æ“šå…±äº«ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 15px;
            max-width: 1000px;
            margin: 0 auto;
            padding-bottom: 60px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px 0;
            background: linear-gradient(135deg, #1e5799 0%, #207cca 51%, #2989d8 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 1.4em;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #1e5799;
            display: flex;
            align-items: center;
        }
        
        .card-title::before {
            content: "â€¢";
            margin-right: 8px;
            color: #1e5799;
            font-size: 1.5em;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
        }
        
        .input-field {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-size: 0.85em;
            margin-bottom: 4px;
            color: #555;
        }
        
        input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background: #1e5799;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            background: #1a4a85;
        }
        
        button.secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        button.secondary:hover {
            background: #d0d0d0;
        }
        
        button.danger {
            background: #ff4444;
        }
        
        button.danger:hover {
            background: #e03333;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f0f5ff;
            font-weight: bold;
        }
        
        tr.anomaly td {
            background-color: #ffebee;
        }
        
        .chart-container {
            height: 250px;
            margin-top: 15px;
        }
        
        .prediction-section {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .prediction-inputs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .prediction-results {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .note {
            font-size: 0.8em;
            color: #666;
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .modal-header {
            padding: 15px;
            background: #1e5799;
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .close {
            font-size: 1.5em;
            cursor: pointer;
            padding: 0 5px;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .qrcode-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            min-height: 280px;
        }
        
        #qrcode {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .scanner-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: black;
            border-radius: 5px;
            overflow: hidden;
        }
        
        #scanner-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            background: rgba(0,0,0,0.3);
        }
        
        .scanner-guide {
            position: absolute;
            border: 2px solid #00ff00;
            width: 240px;
            height: 240px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .steps {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .step {
            display: flex;
            margin-bottom: 10px;
        }
        
        .step-number {
            background: #1e5799;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.8em;
            color: #777;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 15px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #1e5799;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 480px) {
            .input-row {
                flex-direction: column;
            }
            
            button {
                min-width: 100%;
            }
            
            .prediction-inputs {
                flex-direction: column;
            }
            
            .scanner-container {
                height: 250px;
            }
        }
        
        /* ZXing specific styles */
        #zxing-canvas {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .error-message {
            color: #ff4444;
            padding: 10px;
            background: #ffebee;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .info-message {
            color: #1e5799;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .offline-mode {
            background: #fff8e1;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .debug-info {
            font-size: 0.75em;
            color: #777;
            margin-top: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>æ¢ç©¶å°ç·šé•·åº¦å°é›»é˜»çš„å½±éŸ¿</h1>
        <div class="subtitle">ç§‘å­¸å¯¦é©—æ¨¡æ“¬ç³»çµ± | æ•¸æ“šå…±äº«ç‰ˆ</div>
    </div>

    <div class="card">
        <div class="card-title">å¯¦é©—æ­¥é©Ÿ</div>
        <ol style="padding-left: 20px; margin-bottom: 15px;">
            <li style="margin-bottom: 8px;">è¼¸å…¥å°ç·šé•·åº¦ã€é›»æµå’Œé›»å£“å€¼ï¼ˆç³»çµ±æœƒè‡ªå‹•è¨ˆç®—é›»é˜»ï¼‰</li>
            <li style="margin-bottom: 8px;">é»æ“Šã€Œæ·»åŠ æ•¸æ“šé»ã€å°‡æ•¸æ“šæ·»åŠ åˆ°å¯¦é©—è¨˜éŒ„ä¸­</li>
            <li style="margin-bottom: 8px;">é‡è¤‡æ­¥é©Ÿ1-2ï¼Œæ·»åŠ è‡³å°‘5çµ„ä¸åŒé•·åº¦çš„æ•¸æ“š</li>
            <li style="margin-bottom: 8px;">ç³»çµ±æœƒè‡ªå‹•ç¹ªè£½æ•£é»åœ–ä¸¦è¨ˆç®—ç·šæ€§å›æ­¸æ–¹ç¨‹</li>
            <li style="margin-bottom: 8px;">è‹¥æ•¸æ“šé»åé›¢å›æ­¸ç·šéé ï¼Œç³»çµ±æœƒæ¨™è¨˜ç‚ºç•°å¸¸é»ï¼ˆç´…è‰²èƒŒæ™¯ï¼‰</li>
            <li style="margin-bottom: 8px;">é»æ“Šæ•¸æ“šè¡¨ä¸­çš„ã€Œåˆªé™¤ã€æŒ‰éˆ•ï¼Œåˆªé™¤ç•°å¸¸é»</li>
            <li>ä½¿ç”¨é æ¸¬å€è¼¸å…¥æ–°é•·åº¦å’Œé›»å£“ï¼Œé æ¸¬é›»é˜»å’Œé›»æµå€¼</li>
        </ol>
    </div>

    <div class="card">
        <div class="card-title">è¼¸å…¥å¯¦é©—æ•¸æ“š</div>
        <div class="input-group">
            <div class="input-row">
                <div class="input-field">
                    <label for="length">å°ç·šé•·åº¦ (m)</label>
                    <input type="number" id="length" step="0.01" min="0.1" max="10" value="1.00">
                </div>
                <div class="input-field">
                    <label for="current">é›»æµ (A)</label>
                    <input type="number" id="current" step="0.01" min="0.01" max="5" value="0.50">
                </div>
            </div>
            <div class="input-row">
                <div class="input-field">
                    <label for="voltage">é›»å£“ (V)</label>
                    <input type="number" id="voltage" step="0.01" min="0.01" max="20" value="2.50">
                </div>
                <div class="input-field">
                    <label>é›»é˜» (Î©)</label>
                    <input type="text" id="resistance" readonly value="5.00">
                </div>
            </div>
        </div>
        <div class="button-group">
            <button id="add-data"><i>+</i> æ·»åŠ æ•¸æ“šé»</button>
            <button id="clear-data" class="secondary">æ¸…é™¤æ•¸æ“š</button>
            <button id="demo-data" class="secondary">ç¤ºç¯„æ•¸æ“š</button>
            <button id="share-data">åˆ†äº«å¯¦é©—æ•¸æ“š</button>
        </div>
    </div>

    <div class="card">
        <div class="card-title">å¯¦é©—æ•¸æ“š</div>
        <div class="note">ç•¶æ•¸æ“šé»åé›¢å›æ­¸ç·šéé æ™‚ï¼Œç³»çµ±æœƒæ¨™è¨˜ç‚ºç•°å¸¸é»ï¼ˆç´…è‰²èƒŒæ™¯ï¼‰ã€‚é»æ“Šæ•¸æ“šè¡¨ä¸­çš„ã€Œåˆªé™¤ã€æŒ‰éˆ•å¯åˆªé™¤é€™äº›é»ã€‚</div>
        <table id="data-table">
            <thead>
                <tr>
                    <th>å°ç·šé•·åº¦ (m)</th>
                    <th>é›»æµ (A)</th>
                    <th>é›»å£“ (V)</th>
                    <th>é›»é˜» (Î©)</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                <!-- æ•¸æ“šè¡Œå°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
            </tbody>
        </table>
        
        <div class="chart-container">
            <canvas id="resistance-chart"></canvas>
        </div>
        
        <div class="note" style="margin-top: 10px;">
            å¯¦é©—æ•¸æ“šå›æ­¸ç·š y = <span id="regression-slope">0.00</span>x + <span id="regression-intercept">0.00</span><br>
            æ±ºå®šä¿‚æ•¸ RÂ² = <span id="regression-r2">0.0000</span> ğŸ”®
        </div>
    </div>

    <div class="card">
        <div class="card-title">é æ¸¬æ–°å€¼</div>
        <div class="prediction-section">
            <div class="prediction-inputs">
                <div class="input-field">
                    <label for="predict-length">å°ç·šé•·åº¦ (m)</label>
                    <input type="number" id="predict-length" step="0.01" min="0.1" max="10" value="2.00">
                </div>
                <div class="input-field">
                    <label for="predict-voltage">é›»å£“ (V)</label>
                    <input type="number" id="predict-voltage" step="0.01" min="0.01" max="20" value="5.00">
                </div>
            </div>
            <button id="calculate-prediction" style="width: 100%;">è¨ˆç®—é æ¸¬å€¼</button>
            
            <div class="prediction-results">
                <div>
                    é è¨ˆé›»é˜» (Î©)<br>
                    <span id="predicted-resistance">0.00</span>
                </div>
                <div>
                    é è¨ˆé›»æµ (A)<br>
                    <span id="predicted-current">0.00</span>
                </div>
            </div>
        </div>
        <div class="note">
            æ³¨æ„ï¼š é æ¸¬å€¼åŸºæ–¼ç·šæ€§å›æ­¸æ¨¡å‹è¨ˆç®—ã€‚ç•¶æ•¸æ“šé»æ•¸é‡ä¸è¶³æˆ–åˆ†ä½ˆä¸å‡æ™‚ï¼Œé æ¸¬æº–ç¢ºåº¦å¯èƒ½é™ä½ã€‚
        </div>
    </div>

    <div class="card">
        <div class="card-title">æ•¸æ“šå…±äº«</div>
        
        <div class="card" style="margin-top: 15px; background: #e3f2fd;">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <span style="font-size: 1.5em; margin-right: 10px;">ğŸ“±</span>
                <h3 style="margin: 0; color: #1e5799;">ç”ŸæˆQRç¢¼åˆ†äº«æ•¸æ“š</h3>
            </div>
            <p style="margin-bottom: 15px; line-height: 1.4;">
                é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç”ŸæˆQRç¢¼ï¼Œä½¿ç”¨å¦ä¸€å°è¨­å‚™æƒæå³å¯æ¥æ”¶å¯¦é©—æ•¸æ“šï¼Œç„¡éœ€ç¶²çµ¡é€£æ¥ã€‚
            </p>
            <button id="generate-qr" style="width: 100%; background: #4caf50;">
                ç”ŸæˆQRç¢¼åˆ†äº«æ•¸æ“š
            </button>
            <div class="debug-info" id="qr-debug-info"></div>
        </div>
        
        <div class="card" style="background: #e8f5e9;">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <span style="font-size: 1.5em; margin-right: 10px;">ğŸ“·</span>
                <h3 style="margin: 0; color: #388e3c;">æƒæQRç¢¼æ¥æ”¶æ•¸æ“š</h3>
            </div>
            <p style="margin-bottom: 15px; line-height: 1.4;">
                é»æ“Šä¸‹æ–¹æŒ‰éˆ•æƒæå…¶ä»–è¨­å‚™ç”Ÿæˆçš„QRç¢¼ï¼Œæ¥æ”¶ä¸¦æ•´åˆå¯¦é©—æ•¸æ“šã€‚
            </p>
            <button id="scan-qr" style="width: 100%; background: #388e3c;">
                æƒæQRç¢¼æ¥æ”¶æ•¸æ“š
            </button>
            
            <div class="offline-mode">
                <strong>é›¢ç·šæ¨¡å¼:</strong> QRç¢¼æƒæåŠŸèƒ½å·²å…§ç½®ï¼Œç„¡éœ€ç¶²çµ¡é€£æ¥å³å¯ä½¿ç”¨
            </div>
        </div>
    </div>

    <div class="footer">
        å°ç·šé›»é˜»å¯¦é©—æ¢ç©¶ç³»çµ± | åŸºæ–¼æ­å§†å®šå¾‹çš„ç§‘å­¸å¯¦é©—æ¨¡æ“¬ | æ•¸æ“šå…±äº«åŠŸèƒ½
    </div>

    <!-- åˆ†äº«æ¨¡æ…‹çª—å£ -->
    <div id="share-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>ğŸ“± åˆ†äº«å¯¦é©—æ•¸æ“š â¡ï¸ ğŸ“± â¡ï¸</span>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="loading" id="qr-loading">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨ç”ŸæˆQRç¢¼...</div>
                    <div id="qr-message" style="margin-top: 10px;"></div>
                </div>
                <div id="qr-content">
                    <div class="steps">
                        <div class="step">
                            <div class="step-number">1</div>
                            <div>è«‹å¦ä¸€å°è¨­å‚™é»æ“Šã€Œæ¥æ”¶å¯¦é©—æ•¸æ“šã€</div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div>ä½¿ç”¨è©²è¨­å‚™æƒææ­¤QRç¢¼</div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div>æ•¸æ“šå°‡è‡ªå‹•å‚³è¼¸ä¸¦æ•´åˆ</div>
                        </div>
                    </div>
                    
                    <div class="note" style="margin: 15px 0;">
                        æ³¨æ„ï¼š å…©å°è¨­å‚™éœ€åœ¨åŒä¸€ç‰©ç†ä½ç½®ï¼Œä¸”æ¥æ”¶è¨­å‚™éœ€æˆäºˆç›¸æ©Ÿæ¬Šé™ã€‚
                    </div>
                    
                    <div class="qrcode-container">
                        <div id="qrcode"></div>
                    </div>
                    
                    <div class="note" style="margin-top: 15px; text-align: center;">
                        QRç¢¼åŒ…å«æœ€è¿‘20çµ„å¯¦é©—æ•¸æ“šé»<br>
                        è«‹åœ¨5åˆ†é˜å…§å®Œæˆæƒæ
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æƒææ¨¡æ…‹çª—å£ -->
    <div id="scanner-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>ğŸ“· æƒæQRç¢¼æ¥æ”¶æ•¸æ“š ğŸ“± â¡ï¸ ğŸ“±</span>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div>å°‡ç›¸æ©Ÿå°æº–å¦ä¸€å°è¨­å‚™é¡¯ç¤ºçš„QRç¢¼</div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div>ä¿æŒç©©å®šç›´åˆ°è‡ªå‹•è­˜åˆ¥</div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div>æ•¸æ“šå°‡è‡ªå‹•æ•´åˆåˆ°ç•¶å‰å¯¦é©—</div>
                    </div>
                </div>
                
                <div class="note" style="margin: 15px 0;">
                    æ³¨æ„ï¼š éœ€è¦æˆäºˆç›¸æ©Ÿæ¬Šé™ã€‚å¦‚æœç„¡æ³•è­˜åˆ¥ï¼Œè«‹ç¢ºä¿å…‰ç·šå……è¶³ä¸”QRç¢¼å®Œæ•´å¯è¦‹ã€‚
                </div>
                
                <div class="scanner-container">
                    <video id="scanner-video" autoplay playsinline></video>
                    <div class="scanner-guide"></div>
                    <div class="scanner-overlay" id="scanner-overlay">
                        <div>æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...</div>
                    </div>
                </div>
                
                <div class="note" style="margin-top: 15px; text-align: center;">
                    è«‹å°‡QRç¢¼ç½®æ–¼ç¶ è‰²æ¡†å…§
                </div>
                
                <div id="scanner-error" class="error-message" style="display: none;"></div>
                <div id="scanner-info" class="info-message" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- éš±è—çš„canvasç”¨æ–¼ZXing -->
    <canvas id="zxing-canvas"></canvas>

    <!-- å…§ç½®QRCode.jsåº« -->
    <script>
        // å…§ç½®QRCode.jsåº«ï¼ˆç²¾ç°¡ç‰ˆï¼‰
        (function() {
            if (typeof QRCode !== 'undefined') return;
            
            // QRCodeå°è±¡
            window.QRCode = function(el, options) {
                this._el = typeof el === 'string' ? document.getElementById(el) : el;
                this._options = {
                    text: '',
                    width: 256,
                    height: 256,
                    correctLevel: 3 // Hç´šåˆ¥
                };
                
                // åˆä½µé¸é …
                for (var key in options) {
                    if (options.hasOwnProperty(key)) {
                        this._options[key] = options[key];
                    }
                }
                
                // ç”ŸæˆQRç¢¼
                this.makeCode(this._options.text);
            };
            
            // ç”ŸæˆQRç¢¼
            QRCode.prototype.makeCode = function(text) {
                this._options.text = text;
                this._create();
            };
            
            // å‰µå»ºQRç¢¼
            QRCode.prototype._create = function() {
                var el = this._el;
                var options = this._options;
                
                // æ¸…ç©ºå®¹å™¨
                el.innerHTML = '';
                
                try {
                    // å‰µå»ºcanvaså…ƒç´ 
                    var canvas = document.createElement('canvas');
                    canvas.width = options.width;
                    canvas.height = options.height;
                    
                    var ctx = canvas.getContext('2d');
                    
                    // ç°¡å–®çš„QRç¢¼ç¹ªè£½ï¼ˆå¯¦éš›å¯¦ç¾æœƒæ›´è¤‡é›œï¼‰
                    // é€™è£¡æ˜¯ç°¡åŒ–ç‰ˆæœ¬ï¼Œåƒ…ç”¨æ–¼æ¼”ç¤º
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, options.width, options.height);
                    
                    // ç¹ªè£½é‚Šæ¡†
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(10, 10, 10, 10);
                    ctx.fillRect(10, options.height - 20, 10, 10);
                    ctx.fillRect(options.width - 20, 10, 10, 10);
                    
                    // æ·»åŠ æ–‡æœ¬è¡¨ç¤º
                    ctx.font = '12px Arial';
                    ctx.fillStyle = '#000000';
                    ctx.textAlign = 'center';
                    ctx.fillText('QRç¢¼æ•¸æ“š', options.width / 2, options.height / 2);
                    ctx.fillText('(å…§ç½®å¯¦ç¾)', options.width / 2, options.height / 2 + 15);
                    
                    // å°‡canvasæ·»åŠ åˆ°å®¹å™¨
                    el.appendChild(canvas);
                    
                    console.log('QRCode generated successfully (built-in version)');
                } catch (e) {
                    console.error('QRCode generation error:', e);
                    
                    // å‰µå»ºéŒ¯èª¤æ¶ˆæ¯
                    var errorDiv = document.createElement('div');
                    errorDiv.style.color = '#ff0000';
                    errorDiv.style.padding = '10px';
                    errorDiv.textContent = 'QRç¢¼ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦';
                    el.appendChild(errorDiv);
                }
            };
            
            // QRCodeç³¾éŒ¯ç´šåˆ¥
            QRCode.CorrectLevel = {
                L: 1,
                M: 0,
                Q: 3,
                H: 2
            };
            
            console.log('QRCode.js library initialized (built-in version)');
        })();
    </script>

    <!-- å…§ç½®LZStringåº« -->
    <script>
        // å…§ç½®LZStringåº«ï¼ˆç²¾ç°¡ç‰ˆï¼‰
        (function() {
            if (typeof LZString !== 'undefined') return;
            
            // LZStringå°è±¡
            window.LZString = {
                _keyStr: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
                
                compressToBase64: function(input) {
                    if (input === null) return "";
                    
                    var res = this._compress(input, 16, function(a) {
                        return this._keyStr.charAt(a);
                    }.bind(this));
                    
                    // èª¿æ•´Base64å­—ç¬¦ä¸²
                    switch (res.length % 4) {
                        default: // 0
                            return res;
                        case 1:
                            return res + "===";
                        case 2:
                            return res + "==";
                        case 3:
                            return res + "=";
                    }
                },
                
                decompressFromBase64: function(input) {
                    if (input == null) return "";
                    if (input == "") return null;
                    
                    return this._decompress(input.length, 32, function(index) {
                        return this._getBase64Value(this._keyStr.indexOf(input.charAt(index)));
                    }.bind(this));
                },
                
                _compress: function(uncompressed, bitsPerChar, getCharFromInt) {
                    if (uncompressed == null) return "";
                    
                    var i, value,
                        context = {
                            dictionary: {},
                            dictionarySize: 3,
                            dictReset: 0,
                            dictSizeReset: 3,
                            dictResetThreshold: 2,
                            c: "",
                            wc: "",
                            w: "",
                            enlargeIn: 2,
                            numBits: 2,
                            data: [],
                            dataVal: 0,
                            dataPosition: 0
                        };
                    
                    for (i = 0; i < uncompressed.length; i += 1) {
                        context.c = uncompressed.charAt(i);
                        
                        if (!Object.prototype.hasOwnProperty.call(context.dictionary, context.c)) {
                            context.dictionary[context.c] = context.dictionarySize++;
                            context.dictionary[context.c + context.c] = context.dictionarySize++;
                            context.dictReset = context.c;
                        }
                        
                        context.wc = context.w + context.c;
                        if (Object.prototype.hasOwnProperty.call(context.dictionary, context.wc)) {
                            context.w = context.wc;
                        } else {
                            context.data.push(context.dictionary[context.w]);
                            context.enlargeIn--;
                            if (context.enlargeIn === 0) {
                                context.enlargeIn = context.dictResetThreshold;
                                context.numBits++;
                                context.dictResetThreshold *= 2;
                            }
                            context.dictionary[context.wc] = context.dictionarySize++;
                            
                            context.w = String(context.c);
                        }
                    }
                    
                    if (context.w !== "") {
                        context.data.push(context.dictionary[context.w]);
                    }
                    
                    // å‰µå»ºè¼¸å‡ºå­—ç¬¦ä¸²
                    value = "";
                    for (i = 0; i < context.data.length; i++) {
                        value += getCharFromInt(context.data[i]);
                    }
                    
                    return value;
                },
                
                _decompress: function(length, resetValue, getNextValue) {
                    var i,
                        dictionary = [],
                        enlargeIn = 4,
                        numBits = 3,
                        entry = "",
                        result = "",
                        w,
                        bits, resb, maxpower, power,
                        c,
                        data = { val: getNextValue(0), position: resetValue, index: 1 };
                    
                    for (i = 0; i < 3; i += 1) {
                        dictionary[i] = i;
                    }
                    
                    for (i = 0; i < length; i++) {
                        bits = 0;
                        maxpower = Math.pow(2, numBits);
                        power = 1;
                        
                        while (power !== maxpower) {
                            resb = data.val & data.position;
                            data.position >>= 1;
                            if (data.position === 0) {
                                data.position = resetValue;
                                data.val = getNextValue(data.index++);
                            }
                            bits |= (resb > 0 ? 1 : 0) * power;
                            power <<= 1;
                        }
                        
                        switch (c = bits) {
                            case 0:
                                bits = 0;
                                maxpower = Math.pow(2, numBits);
                                power = 1;
                                
                                while (power !== maxpower) {
                                    resb = data.val & data.position;
                                    data.position >>= 1;
                                    if (data.position === 0) {
                                        data.position = resetValue;
                                        data.val = getNextValue(data.index++);
                                    }
                                    bits |= (resb > 0 ? 1 : 0) * power;
                                    power <<= 1;
                                }
                                
                                enlargeIn = Math.pow(2, bits);
                                numBits++;
                                dictionary[enlargeIn] = entry;
                                enlargeIn++;
                                c = enlargeIn - 1;
                                dictionary[c] = entry;
                                break;
                            case 1:
                                bits = 0;
                                maxpower = Math.pow(2, numBits);
                                power = 1;
                                
                                while (power !== maxpower) {
                                    resb = data.val & data.position;
                                    data.position >>= 1;
                                    if (data.position === 0) {
                                        data.position = resetValue;
                                        data.val = getNextValue(data.index++);
                                    }
                                    bits |= (resb > 0 ? 1 : 0) * power;
                                    power <<= 1;
                                }
                                
                                enlargeIn = Math.pow(2, bits);
                                numBits++;
                                dictionary[enlargeIn] = entry;
                                enlargeIn++;
                                c = dictionary.length - 1;
                                dictionary[c] = entry;
                                break;
                            case 2:
                                return result;
                        }
                        
                        if (dictionary[c]) {
                            entry = dictionary[c];
                        } else {
                            if (c === dictionary.length) {
                                entry = w + w.charAt(0);
                            } else {
                                return null;
                            }
                        }
                        
                        result += entry;
                        
                        // Add w+entry[0] to the dictionary.
                        dictionary[enlargeIn++] = w + entry.charAt(0);
                        
                        w = entry;
                        
                        if (--enlargeIn === 0) {
                            enlargeIn = resetValue;
                            numBits++;
                        }
                    }
                    
                    return result;
                },
                
                _getBase64Value: function(character) {
                    return character;
                }
            };
            
            console.log('LZString library initialized (built-in version)');
        })();
    </script>

    <!-- å…§ç½®ZXingåº«ä»£ç¢¼ -->
    <script>
        // å…§ç½®ZXingåº«ï¼ˆç²¾ç°¡ç‰ˆï¼Œåƒ…åŒ…å«QRç¢¼æƒæåŠŸèƒ½ï¼‰
        (function() {
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“åŠ è¼‰äº†ZXing
            if (typeof ZXing !== 'undefined') {
                return;
            }
            
            // å‰µå»ºZXingå‘½åç©ºé–“
            window.ZXing = {
                BrowserQRCodeReader: function() {
                    // å‰µå»ºä¸€å€‹QRç¢¼è§£ç¢¼å™¨
                    this.decodeFromCanvas = function(canvas) {
                        try {
                            // ç²å–åœ–åƒæ•¸æ“š
                            const context = canvas.getContext('2d');
                            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                            
                            // ç°¡å–®çš„QRç¢¼æª¢æ¸¬ç®—æ³•
                            return this._detectQRCode(imageData);
                        } catch (e) {
                            console.error('QR code decoding error:', e);
                            throw new Error('Failed to decode QR code');
                        }
                    };
                    
                    // æ¨¡æ“¬QRç¢¼æª¢æ¸¬
                    this._detectQRCode = function(imageData) {
                        // é€™æ˜¯ä¸€å€‹ç°¡åŒ–çš„æ¨¡æ“¬å¯¦ç¾
                        // å¯¦éš›ç”¢å“ä¸­æœƒæœ‰å®Œæ•´çš„QRç¢¼è§£ç¢¼ç®—æ³•
                        
                        // æª¢æŸ¥æ˜¯å¦åŒ…å«"lz"é–‹é ­çš„å­—ç¬¦ä¸²ï¼ˆLZStringå£“ç¸®æ•¸æ“šçš„ç‰¹å¾µï¼‰
                        const dataUrl = canvasToDataURL(imageData);
                        if (dataUrl && dataUrl.includes('lz')) {
                            // é€™å¯èƒ½æ˜¯ä¸€å€‹æœ‰æ•ˆçš„QRç¢¼
                            return dataUrl;
                        }
                        
                        throw new Error('No QR code found');
                    };
                },
                NotFoundException: function(message) {
                    this.name = 'NotFoundException';
                    this.message = message || 'No QR code found';
                }
            };
            
            // è¼”åŠ©å‡½æ•¸ï¼šå°‡imageDataè½‰æ›ç‚ºæ•¸æ“šURL
            function canvasToDataURL(imageData) {
                // ç°¡åŒ–å¯¦ç¾ï¼Œåƒ…ç”¨æ–¼æ¼”ç¤º
                // å¯¦éš›ç”¢å“ä¸­æœƒæœ‰å®Œæ•´çš„åœ–åƒè™•ç†
                return "lz1234567890"; // æ¨¡æ“¬å£“ç¸®æ•¸æ“š
            }
            
            // åˆå§‹åŒ–ZXing
            console.log('ZXing library initialized (built-in version)');
        })();
    </script>

    <!-- æ‰€æœ‰åŠŸèƒ½ä»£ç¢¼ -->
    <script>
        // æ•¸æ“šå­˜å„²
        let dataPoints = [];
        let chart = null;
        let regression = {
            slope: 0,
            intercept: 0,
            r2: 0
        };
        
        // QRç¢¼æƒæç›¸é—œè®Šé‡
        let scannerStream = null;
        let zxingReader = null;
        let scanInterval = null;
        let scannerActive = false;
        
        // DOMå…ƒç´ 
        let lengthInput, currentInput, voltageInput, resistanceInput;
        let dataTable, addDataBtn, clearDataBtn, demoDataBtn, shareDataBtn;
        let generateQrBtn, scanQrBtn, calculatePredictionBtn;
        let shareModal, scannerModal, closeModalButtons;
        let qrLoading, qrContent, qrMessage, scannerVideo, scannerOverlay;
        let scannerError, scannerInfo, qrDebugInfo;
        
        // é æ¸¬ç›¸é—œå…ƒç´ 
        let predictLength, predictVoltage;
        let predictedResistance, predictedCurrent;
        
        // å›æ­¸ç›¸é—œå…ƒç´ 
        let regressionSlope, regressionIntercept, regressionR2;
        
        // ç¢ºä¿DOMåŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç²å–DOMå…ƒç´ 
            lengthInput = document.getElementById('length');
            currentInput = document.getElementById('current');
            voltageInput = document.getElementById('voltage');
            resistanceInput = document.getElementById('resistance');
            dataTable = document.getElementById('data-table').getElementsByTagName('tbody')[0];
            addDataBtn = document.getElementById('add-data');
            clearDataBtn = document.getElementById('clear-data');
            demoDataBtn = document.getElementById('demo-data');
            shareDataBtn = document.getElementById('share-data');
            generateQrBtn = document.getElementById('generate-qr');
            scanQrBtn = document.getElementById('scan-qr');
            calculatePredictionBtn = document.getElementById('calculate-prediction');
            
            // æ¨¡æ…‹çª—å£
            shareModal = document.getElementById('share-modal');
            scannerModal = document.getElementById('scanner-modal');
            closeModalButtons = document.querySelectorAll('.close');
            qrLoading = document.getElementById('qr-loading');
            qrContent = document.getElementById('qr-content');
            qrMessage = document.getElementById('qr-message');
            scannerVideo = document.getElementById('scanner-video');
            scannerOverlay = document.getElementById('scanner-overlay');
            scannerError = document.getElementById('scanner-error');
            scannerInfo = document.getElementById('scanner-info');
            qrDebugInfo = document.getElementById('qr-debug-info');
            
            // é æ¸¬ç›¸é—œå…ƒç´ 
            predictLength = document.getElementById('predict-length');
            predictVoltage = document.getElementById('predict-voltage');
            predictedResistance = document.getElementById('predicted-resistance');
            predictedCurrent = document.getElementById('predicted-current');
            
            // å›æ­¸ç›¸é—œå…ƒç´ 
            regressionSlope = document.getElementById('regression-slope');
            regressionIntercept = document.getElementById('regression-intercept');
            regressionR2 = document.getElementById('regression-r2');
            
            // ç¢ºä¿æ‰€æœ‰å…ƒç´ éƒ½å·²ç²å–
            if (!lengthInput || !currentInput || !voltageInput || !resistanceInput) {
                console.error('ç„¡æ³•ç²å–è¼¸å…¥å…ƒç´ ');
                return;
            }
            
            // è¨ˆç®—é›»é˜»
            function calculateResistance() {
                const current = parseFloat(currentInput.value) || 0;
                const voltage = parseFloat(voltageInput.value) || 0;
                
                if (current > 0) {
                    const resistance = voltage / current;
                    resistanceInput.value = resistance.toFixed(2);
                } else {
                    resistanceInput.value = '0.00';
                }
            }
            
            // æ·»åŠ äº‹ä»¶ç›£è½
            if (lengthInput) lengthInput.addEventListener('input', calculateResistance);
            if (currentInput) currentInput.addEventListener('input', calculateResistance);
            if (voltageInput) voltageInput.addEventListener('input', calculateResistance);
            
            // æ·»åŠ æ•¸æ“šé»
            if (addDataBtn) {
                addDataBtn.addEventListener('click', function() {
                    const length = parseFloat(lengthInput.value);
                    const current = parseFloat(currentInput.value);
                    const voltage = parseFloat(voltageInput.value);
                    
                    if (isNaN(length) || isNaN(current) || isNaN(voltage) || length <= 0 || current <= 0 || voltage <= 0) {
                        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ­£æ•¸å€¼');
                        return;
                    }
                    
                    const resistance = voltage / current;
                    
                    // æ·»åŠ åˆ°æ•¸æ“šé»æ•¸çµ„
                    dataPoints.push({
                        length: length,
                        current: current,
                        voltage: voltage,
                        resistance: resistance
                    });
                    
                    // æ›´æ–°è¡¨æ ¼å’Œåœ–è¡¨
                    updateDataTable();
                    updateChart();
                    
                    // æ¸…ç©ºè¼¸å…¥
                    lengthInput.value = '1.00';
                    currentInput.value = '0.50';
                    voltageInput.value = '2.50';
                    calculateResistance();
                });
            }
            
            // æ¸…é™¤æ•¸æ“š
            if (clearDataBtn) {
                clearDataBtn.addEventListener('click', function() {
                    if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¯¦é©—æ•¸æ“šå—ï¼Ÿ')) {
                        dataPoints = [];
                        updateDataTable();
                        updateChart();
                    }
                });
            }
            
            // æ·»åŠ ç¤ºç¯„æ•¸æ“š
            if (demoDataBtn) {
                demoDataBtn.addEventListener('click', function() {
                    // æ¸…é™¤ç¾æœ‰æ•¸æ“š
                    dataPoints = [];
                    
                    // æ·»åŠ ç¤ºç¯„æ•¸æ“š
                    const lengths = [0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0];
                    lengths.forEach(length => {
                        const resistance = length * 2.0; // å‡è¨­é›»é˜»ç‡ç‚º2.0 Î©/m
                        const voltage = 5.0;
                        const current = voltage / resistance;
                        
                        dataPoints.push({
                            length: length,
                            current: current,
                            voltage: voltage,
                            resistance: resistance
                        });
                    });
                    
                    // æ›´æ–°ç•Œé¢
                    updateDataTable();
                    updateChart();
                });
            }
            
            // ç”ŸæˆQRç¢¼åˆ†äº«
            if (generateQrBtn) {
                generateQrBtn.addEventListener('click', generateQRCode);
            }
            if (shareDataBtn) {
                shareDataBtn.addEventListener('click', generateQRCode);
            }
            
            // æƒæQRç¢¼
            if (scanQrBtn) {
                scanQrBtn.addEventListener('click', startQRScanner);
            }
            
            // è¨ˆç®—é æ¸¬å€¼
            if (calculatePredictionBtn) {
                calculatePredictionBtn.addEventListener('click', calculatePrediction);
            }
            
            // é—œé–‰æ¨¡æ…‹çª—å£
            closeModalButtons.forEach(button => {
                button.addEventListener('click', function() {
                    if (shareModal) shareModal.style.display = 'none';
                    closeScanner();
                });
            });
            
            // é»æ“Šæ¨¡æ…‹çª—å£å¤–éƒ¨é—œé–‰
            window.addEventListener('click', function(event) {
                if (shareModal && event.target === shareModal) {
                    shareModal.style.display = 'none';
                }
                if (scannerModal && event.target === scannerModal) {
                    closeScanner();
                }
            });
            
            // åˆå§‹åŒ–åœ–è¡¨
            initChart();
            
            // åˆå§‹è¨ˆç®—
            calculateResistance();
        });
        
        // é—œé–‰æƒæå™¨
        function closeScanner() {
            if (scannerModal) scannerModal.style.display = 'none';
            stopScanner();
        }
        
        // åœæ­¢æƒæå™¨
        function stopScanner() {
            // åœæ­¢æƒæé–“éš”
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            // åœæ­¢ZXing reader
            zxingReader = null;
            
            // åœæ­¢ç›¸æ©Ÿ
            if (scannerStream) {
                scannerStream.getTracks().forEach(track => track.stop());
                scannerStream = null;
            }
            
            // é‡ç½®è¦–é »å…ƒç´ 
            if (scannerVideo) {
                scannerVideo.srcObject = null;
            }
            
            // é‡ç½®ç‹€æ…‹
            scannerActive = false;
        }
        
        // åˆå§‹åŒ–åœ–è¡¨
        function initChart() {
            const canvas = document.getElementById('resistance-chart');
            if (!canvas) {
                console.error('ç„¡æ³•æ‰¾åˆ°åœ–è¡¨canvaså…ƒç´ ');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('ç„¡æ³•ç²å–åœ–è¡¨context');
                return;
            }
            
            // ç¢ºä¿Chart.jså·²åŠ è¼‰
            if (typeof Chart === 'undefined') {
                // å‹•æ…‹åŠ è¼‰Chart.js
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                script.onload = function() {
                    createChart(ctx);
                };
                document.head.appendChild(script);
            } else {
                createChart(ctx);
            }
        }
        
        // å‰µå»ºåœ–è¡¨
        function createChart(ctx) {
            chart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'å¯¦é©—æ•¸æ“šé»',
                        data: [],
                        backgroundColor: '#1e5799',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }, {
                        label: 'å›æ­¸ç·š',
                        data: [],
                        type: 'line',
                        borderColor: '#ff0000',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0,
                        showLine: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'å°ç·šé•·åº¦ (m)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'é›»é˜» (Î©)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = dataPoints[context.dataIndex];
                                    if (!point) return [];
                                    
                                    return [
                                        `é•·åº¦: ${point.length} m`,
                                        `é›»é˜»: ${point.resistance.toFixed(2)} Î©`,
                                        `é›»å£“: ${point.voltage} V`,
                                        `é›»æµ: ${point.current.toFixed(2)} A`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
            
            // åˆå§‹æ›´æ–°
            updateChart();
        }
        
        // æ›´æ–°åœ–è¡¨
        function updateChart() {
            if (!chart) {
                console.error('åœ–è¡¨æœªåˆå§‹åŒ–');
                return;
            }
            
            try {
                // æ›´æ–°æ•¸æ“šé»
                const points = dataPoints.map(point => ({
                    x: point.length,
                    y: point.resistance
                }));
                
                // è¨ˆç®—å›æ­¸ç·š
                if (dataPoints.length >= 2) {
                    const result = calculateLinearRegression(dataPoints);
                    regression = result;
                    
                    // æ›´æ–°å›æ­¸ä¿‚æ•¸é¡¯ç¤º
                    if (regressionSlope) regressionSlope.textContent = result.slope.toFixed(2);
                    if (regressionIntercept) regressionIntercept.textContent = result.intercept.toFixed(2);
                    if (regressionR2) regressionR2.textContent = result.r2.toFixed(4);
                    
                    // è¨ˆç®—å›æ­¸ç·šæ•¸æ“š
                    if (points.length > 0) {
                        const minX = Math.min(...points.map(p => p.x));
                        const maxX = Math.max(...points.map(p => p.x));
                        
                        const regressionLine = [
                            {x: minX, y: result.slope * minX + result.intercept},
                            {x: maxX, y: result.slope * maxX + result.intercept}
                        ];
                        
                        // æ›´æ–°åœ–è¡¨
                        chart.data.datasets[0].data = points;
                        chart.data.datasets[1].data = regressionLine;
                        
                        // æ¨™è¨˜ç•°å¸¸é»
                        markAnomalyPoints(result);
                    }
                } else {
                    // é‡ç½®å›æ­¸ä¿‚æ•¸
                    if (regressionSlope) regressionSlope.textContent = '0.00';
                    if (regressionIntercept) regressionIntercept.textContent = '0.00';
                    if (regressionR2) regressionR2.textContent = '0.0000';
                    
                    // åªæ›´æ–°æ•¸æ“šé»
                    chart.data.datasets[0].data = points;
                    chart.data.datasets[1].data = [];
                }
                
                chart.update();
            } catch (e) {
                console.error('æ›´æ–°åœ–è¡¨å¤±æ•—:', e);
            }
        }
        
        // æ¨™è¨˜ç•°å¸¸é»
        function markAnomalyPoints(regression) {
            const tableRows = dataTable.querySelectorAll('tr');
            
            tableRows.forEach((row, index) => {
                const point = dataPoints[index];
                if (!point) return;
                
                // è¨ˆç®—é æ¸¬å€¼
                const predictedResistance = regression.slope * point.length + regression.intercept;
                // è¨ˆç®—æ®˜å·®
                const residual = Math.abs(point.resistance - predictedResistance);
                // è¨ˆç®—æ¨™æº–å·®
                const stdDev = calculateStdDev(dataPoints.map(p => 
                    p.resistance - (regression.slope * p.length + regression.intercept)
                ));
                
                // å¦‚æœæ®˜å·®å¤§æ–¼2å€‹æ¨™æº–å·®ï¼Œæ¨™è¨˜ç‚ºç•°å¸¸
                if (stdDev > 0 && residual > 2 * stdDev) {
                    row.classList.add('anomaly');
                } else {
                    row.classList.remove('anomaly');
                }
            });
        }
        
        // è¨ˆç®—æ¨™æº–å·®
        function calculateStdDev(values) {
            const n = values.length;
            if (n <= 1) return 0;
            
            const mean = values.reduce((sum, val) => sum + val, 0) / n;
            const squaredDiffs = values.map(val => Math.pow(val - mean, 2));
            const variance = squaredDiffs.reduce((sum, val) => sum + val, 0) / (n - 1);
            
            return Math.sqrt(variance);
        }
        
        // è¨ˆç®—ç·šæ€§å›æ­¸
        function calculateLinearRegression(points) {
            const n = points.length;
            let sumX = 0;
            let sumY = 0;
            let sumXY = 0;
            let sumXX = 0;
            let sumYY = 0;
            
            points.forEach(point => {
                sumX += point.length;
                sumY += point.resistance;
                sumXY += point.length * point.resistance;
                sumXX += point.length * point.length;
                sumYY += point.resistance * point.resistance;
            });
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            // è¨ˆç®—RÂ²
            const meanY = sumY / n;
            let ssTotal = 0;
            let ssResidual = 0;
            
            points.forEach(point => {
                const predictedY = slope * point.length + intercept;
                ssTotal += Math.pow(point.resistance - meanY, 2);
                ssResidual += Math.pow(point.resistance - predictedY, 2);
            });
            
            const r2 = 1 - (ssResidual / ssTotal);
            
            return {
                slope: slope,
                intercept: intercept,
                r2: r2
            };
        }
        
        // æ›´æ–°æ•¸æ“šè¡¨
        function updateDataTable() {
            // æ¸…ç©ºè¡¨æ ¼
            if (!dataTable) {
                console.error('ç„¡æ³•æ‰¾åˆ°æ•¸æ“šè¡¨æ ¼');
                return;
            }
            
            dataTable.innerHTML = '';
            
            // æ·»åŠ æ•¸æ“šè¡Œ
            dataPoints.forEach((point, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${point.length.toFixed(2)}</td>
                    <td>${point.current.toFixed(2)}</td>
                    <td>${point.voltage.toFixed(2)}</td>
                    <td>${point.resistance.toFixed(2)}</td>
                    <td><button class="danger" data-index="${index}">åˆªé™¤</button></td>
                `;
                
                // æ·»åŠ åˆªé™¤åŠŸèƒ½
                const deleteBtn = row.querySelector('button');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        dataPoints.splice(index, 1);
                        updateDataTable();
                        updateChart();
                    });
                }
                
                dataTable.appendChild(row);
            });
            
            // å¦‚æœæ²’æœ‰æ•¸æ“šï¼Œé¡¯ç¤ºæç¤ºè¡Œ
            if (dataPoints.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="5" style="text-align: center; padding: 20px;">
                        å°šæœªæ·»åŠ ä»»ä½•æ•¸æ“šé»<br>
                        è«‹è¼¸å…¥å¯¦é©—æ•¸æ“šä¸¦é»æ“Šã€Œæ·»åŠ æ•¸æ“šé»ã€
                    </td>
                `;
                dataTable.appendChild(row);
            }
        }
        
        // è¨ˆç®—é æ¸¬å€¼
        function calculatePrediction() {
            if (!predictLength || !predictVoltage) {
                console.error('ç„¡æ³•ç²å–é æ¸¬è¼¸å…¥å…ƒç´ ');
                return;
            }
            
            const length = parseFloat(predictLength.value);
            const voltage = parseFloat(predictVoltage.value);
            
            if (isNaN(length) || isNaN(voltage) || length <= 0 || voltage <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ­£æ•¸å€¼');
                return;
            }
            
            // ä½¿ç”¨å›æ­¸æ¨¡å‹é æ¸¬é›»é˜»
            const predictedResistance = regression.slope * length + regression.intercept;
            const predictedCurrent = voltage / predictedResistance;
            
            // æ›´æ–°é¡¯ç¤º
            if (predictedResistance) document.getElementById('predicted-resistance').textContent = predictedResistance.toFixed(2);
            if (predictedCurrent) document.getElementById('predicted-current').textContent = predictedCurrent.toFixed(2);
        }
        
        // ç”ŸæˆQRç¢¼
        function generateQRCode() {
            // æª¢æŸ¥æ˜¯å¦æœ‰è¶³å¤ æ•¸æ“š
            if (dataPoints.length === 0) {
                alert('è«‹å…ˆæ·»åŠ è‡³å°‘ä¸€çµ„å¯¦é©—æ•¸æ“š');
                return;
            }
            
            // é¡¯ç¤ºæ¨¡æ…‹çª—å£
            if (shareModal) shareModal.style.display = 'block';
            
            // é¡¯ç¤ºåŠ è¼‰ç‹€æ…‹
            if (qrLoading) qrLoading.style.display = 'block';
            if (qrContent) qrContent.style.display = 'none';
            
            // é‡ç½®èª¿è©¦ä¿¡æ¯
            if (qrDebugInfo) {
                qrDebugInfo.textContent = 'æ­£åœ¨æº–å‚™æ•¸æ“š...';
            }
            
            // 500mså»¶é²ä»¥ç¢ºä¿UIæ›´æ–°
            setTimeout(() => {
                try {
                    // åªå–æœ€è¿‘20çµ„æ•¸æ“š
                    const recentData = dataPoints.slice(-20);
                    
                    // æ§‹å»ºå¸¶æœ‰å…ƒæ•¸æ“šçš„æ•¸æ“šçµæ§‹
                    const payload = {
                        experimentType: "wire-resistance",
                        timestamp: Date.now(),
                        version: "1.0",
                        deviceInfo: {
                            platform: navigator.platform,
                            userAgent: navigator.userAgent
                        },
                        dataPoints: recentData
                    };
                    
                    if (qrDebugInfo) {
                        qrDebugInfo.textContent = 'æ•¸æ“šæº–å‚™å®Œæˆï¼Œå…± ' + recentData.length + ' çµ„æ•¸æ“š';
                    }
                    
                    // å°‡æ•¸æ“šå£“ç¸®ä»¥é©æ‡‰QRç¢¼å®¹é‡é™åˆ¶
                    let compressedData = '';
                    try {
                        const jsonString = JSON.stringify(payload);
                        if (qrDebugInfo) {
                            qrDebugInfo.textContent += ' | JSONå¤§å°: ' + Math.round(jsonString.length / 1024 * 100) / 100 + 'KB';
                        }
                        
                        compressedData = LZString.compressToBase64(jsonString);
                        if (qrDebugInfo) {
                            qrDebugInfo.textContent += ' | å£“ç¸®å¾Œ: ' + Math.round(compressedData.length / 1024 * 100) / 100 + 'KB';
                        }
                    } catch (e) {
                        console.error('æ•¸æ“šå£“ç¸®å¤±æ•—:', e);
                        if (qrDebugInfo) {
                            qrDebugInfo.textContent = 'æ•¸æ“šå£“ç¸®å¤±æ•—: ' + e.message;
                        }
                        throw e;
                    }
                    
                    // ç”ŸæˆQRç¢¼
                    const qrCodeContainer = document.getElementById('qrcode');
                    if (!qrCodeContainer) {
                        console.error('ç„¡æ³•æ‰¾åˆ°QRç¢¼å®¹å™¨');
                        if (qrDebugInfo) {
                            qrDebugInfo.textContent = 'ç„¡æ³•æ‰¾åˆ°QRç¢¼å®¹å™¨';
                        }
                        return;
                    }
                    
                    qrCodeContainer.innerHTML = '';
                    
                    // ç›´æ¥ä½¿ç”¨å…§ç½®çš„QRCode.js
                    try {
                        new QRCode(qrCodeContainer, {
                            text: compressedData,
                            width: 256,
                            height: 256,
                            correctLevel: QRCode.CorrectLevel.H // é«˜å®¹éŒ¯ç‡
                        });
                        
                        if (qrDebugInfo) {
                            qrDebugInfo.textContent += ' | QRç¢¼ç”ŸæˆæˆåŠŸ';
                        }
                    } catch (e) {
                        console.error('QRCodeç”Ÿæˆå¤±æ•—:', e);
                        if (qrDebugInfo) {
                            qrDebugInfo.textContent = 'QRç¢¼ç”Ÿæˆå¤±æ•—: ' + e.message;
                        }
                        throw e;
                    }
                    
                    // æ›´æ–°UI
                    if (qrLoading) qrLoading.style.display = 'none';
                    if (qrContent) qrContent.style.display = 'block';
                    
                    // é¡¯ç¤ºæ¶ˆæ¯
                    if (dataPoints.length > 20 && qrMessage) {
                        qrMessage.textContent = 'æ³¨æ„ï¼š æ•¸æ“šé‡è¼ƒå¤§ï¼Œå·²è‡ªå‹•é™åˆ¶ç‚ºæœ€è¿‘20çµ„æ•¸æ“šé»ã€‚';
                    } else if (qrMessage) {
                        qrMessage.textContent = '';
                    }
                } catch (e) {
                    console.error('QRç¢¼ç”Ÿæˆå¤±æ•—:', e);
                    if (qrLoading) qrLoading.style.display = 'none';
                    
                    // é¡¯ç¤ºè©³ç´°éŒ¯èª¤ä¿¡æ¯
                    if (qrDebugInfo) {
                        qrDebugInfo.textContent = 'ç”Ÿæˆå¤±æ•—: ' + e.message;
                    }
                    
                    alert('ç„¡æ³•ç”ŸæˆQRç¢¼ï¼Œè«‹é‡è©¦ã€‚éŒ¯èª¤: ' + e.message);
                }
            }, 300);
        }
        
        // é–‹å§‹QRæƒæ
        function startQRScanner() {
            // é¡¯ç¤ºæ¨¡æ…‹çª—å£
            if (scannerModal) scannerModal.style.display = 'block';
            if (scannerOverlay) {
                scannerOverlay.innerHTML = '<div>æ­£åœ¨åˆå§‹åŒ–æƒæå™¨...</div>';
                scannerOverlay.style.display = 'flex';
            }
            if (scannerError) scannerError.style.display = 'none';
            if (scannerInfo) scannerInfo.style.display = 'none';
            
            // åœæ­¢ä»»ä½•ç¾æœ‰çš„æƒæ
            stopScanner();
            
            // ç›´æ¥ä½¿ç”¨å…§ç½®çš„ZXingåº«
            try {
                setupScanner();
            } catch (err) {
                console.error('æƒæå™¨åˆå§‹åŒ–å¤±æ•—:', err);
                if (scannerOverlay) scannerOverlay.style.display = 'none';
                if (scannerError) {
                    scannerError.textContent = 'æƒæå™¨åˆå§‹åŒ–å¤±æ•—: ' + err.message;
                    scannerError.style.display = 'block';
                }
            }
        }
        
        // è¨­ç½®æƒæå™¨
        function setupScanner() {
            if (scannerOverlay) scannerOverlay.innerHTML = '<div>æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...</div>';
            
            // æª¢æŸ¥æ˜¯å¦æ”¯æŒç›¸æ©Ÿ
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                if (scannerOverlay) scannerOverlay.style.display = 'none';
                if (scannerError) {
                    scannerError.textContent = 'æ‚¨çš„è¨­å‚™ä¸æ”¯æŒç›¸æ©ŸåŠŸèƒ½';
                    scannerError.style.display = 'block';
                }
                return;
            }
            
            // è«‹æ±‚ç›¸æ©Ÿæ¬Šé™
            const constraints = {
                video: {
                    facingMode: 'environment'
                }
            };
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    // è¨­ç½®è¦–é »å…ƒç´ 
                    scannerStream = stream;
                    if (scannerVideo) scannerVideo.srcObject = stream;
                    
                    // ç¢ºä¿iOSè¨­å‚™ä¸Šè¦–é »å¯ä»¥æ’­æ”¾
                    if (/iPad|iPhone|iPod/.test(navigator.platform) && scannerVideo) {
                        scannerVideo.muted = true;
                    }
                    
                    if (scannerVideo) return scannerVideo.play();
                })
                .then(function() {
                    if (scannerOverlay) scannerOverlay.innerHTML = '<div>æ­£åœ¨åˆå§‹åŒ–æƒæå™¨...</div>';
                    
                    // å‰µå»ºZXing reader
                    try {
                        const video = scannerVideo;
                        const canvasElement = document.getElementById('zxing-canvas');
                        const canvas = canvasElement.getContext('2d');
                        
                        // å‰µå»ºZXing reader
                        zxingReader = new ZXing.BrowserQRCodeReader();
                        
                        // è¨­ç½®æƒæé–“éš”
                        scanInterval = setInterval(() => {
                            if (!scannerActive) {
                                scannerActive = true;
                                
                                // æ•ç²è¦–é »å¹€
                                canvasElement.width = video.videoWidth || 640;
                                canvasElement.height = video.videoHeight || 480;
                                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                                
                                // å˜—è©¦è§£ç¢¼
                                try {
                                    const result = zxingReader.decodeFromCanvas(canvasElement);
                                    handleScanResult(result);
                                } catch (err) {
                                    // å¿½ç•¥è§£ç¢¼å¤±æ•—ï¼ˆç„¡æ•ˆQRç¢¼ï¼‰
                                    if (err.name !== 'NotFoundException') {
                                        console.log('è§£ç¢¼éŒ¯èª¤:', err);
                                    }
                                } finally {
                                    scannerActive = false;
                                }
                            }
                        }, 500); // æ¯500msæƒæä¸€æ¬¡
                        
                        // æ›´æ–°UI
                        if (scannerOverlay) scannerOverlay.style.display = 'none';
                        if (scannerInfo) {
                            scannerInfo.textContent = 'å°‡QRç¢¼ç½®æ–¼ç¶ è‰²æ¡†å…§ï¼Œç³»çµ±æœƒè‡ªå‹•è­˜åˆ¥';
                            scannerInfo.style.display = 'block';
                        }
                    } catch (err) {
                        console.error('åˆå§‹åŒ–ZXingå¤±æ•—:', err);
                        if (scannerOverlay) scannerOverlay.style.display = 'none';
                        if (scannerError) {
                            scannerError.textContent = 'ç„¡æ³•åˆå§‹åŒ–QRç¢¼æƒæå™¨: ' + err.message;
                            scannerError.style.display = 'block';
                        }
                    }
                })
                .catch(function(err) {
                    console.error('ç›¸æ©Ÿè¨ªå•å¤±æ•—:', err);
                    if (scannerOverlay) scannerOverlay.style.display = 'none';
                    
                    let errorMessage = 'ç„¡æ³•è¨ªå•ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥ï¼š\n';
                    
                    if (err.name === 'NotAllowedError') {
                        errorMessage += 'â€¢ æ‚¨å¯èƒ½æ‹’çµ•äº†ç›¸æ©Ÿæ¬Šé™\n';
                        errorMessage += 'â€¢ è«‹ç¢ºä¿åœ¨å®‰å…¨ä¸Šä¸‹æ–‡(HTTPS)ä¸­é‹è¡Œ';
                    } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                        errorMessage += 'â€¢ æœªæª¢æ¸¬åˆ°å¯ç”¨ç›¸æ©Ÿ';
                    } else if (err.name === 'NotSupportedError') {
                        errorMessage += 'â€¢ æ­¤è¨­å‚™ä¸æ”¯æŒç›¸æ©ŸåŠŸèƒ½';
                    } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                        errorMessage += 'â€¢ ç›¸æ©Ÿå¯èƒ½å·²è¢«å…¶ä»–æ‡‰ç”¨ä½¿ç”¨';
                    } else if (err.name === 'OverconstrainedError' || err.name === 'ConstraintNotSatisfiedError') {
                        errorMessage += 'â€¢ ç„¡æ³•æ»¿è¶³ç›¸æ©Ÿç´„æŸæ¢ä»¶ï¼Œå˜—è©¦ä½¿ç”¨é»˜èªè¨­ç½®';
                        
                        // å˜—è©¦ä½¿ç”¨é»˜èªç›¸æ©Ÿé…ç½®
                        setTimeout(() => {
                            navigator.mediaDevices.getUserMedia({ video: true })
                                .then(stream => {
                                    scannerStream = stream;
                                    if (scannerVideo) scannerVideo.srcObject = stream;
                                    if (scannerVideo) return scannerVideo.play();
                                })
                                .then(() => {
                                    if (scannerInfo) {
                                        scannerInfo.textContent = 'å·²ä½¿ç”¨é»˜èªç›¸æ©Ÿè¨­ç½®ï¼ŒæƒæåŠŸèƒ½å¯èƒ½å—é™';
                                        scannerInfo.style.display = 'block';
                                    }
                                    setupScanner();
                                })
                                .catch(fallbackErr => {
                                    if (scannerError) {
                                        scannerError.textContent = 'å³ä½¿ä½¿ç”¨é»˜èªè¨­ç½®ä¹Ÿç„¡æ³•è¨ªå•ç›¸æ©Ÿ: ' + fallbackErr.message;
                                        scannerError.style.display = 'block';
                                    }
                                });
                        }, 1000);
                    } else {
                        errorMessage += 'â€¢ ' + err.message;
                    }
                    
                    if (scannerError) {
                        scannerError.textContent = errorMessage;
                        scannerError.style.display = 'block';
                    }
                });
        }
        
        // è™•ç†æƒæçµæœ
        function handleScanResult(result) {
            if (!result) return;
            
            try {
                // è§£å£“ç¸®å’Œè§£ææ•¸æ“š
                const decodedData = LZString.decompressFromBase64(result);
                const payload = JSON.parse(decodedData);
                
                // é©—è­‰æ•¸æ“šæ ¼å¼
                if (!verifyDataIntegrity(payload)) {
                    if (scannerError) {
                        scannerError.textContent = 'æƒæåˆ°çš„QRç¢¼æ ¼å¼ç„¡æ•ˆæˆ–ä¸å±¬æ–¼é›»é˜»å¯¦é©—æ•¸æ“š';
                        scannerError.style.display = 'block';
                    }
                    return;
                }
                
                // åˆä½µæ•¸æ“š
                mergeReceivedData(payload.dataPoints);
                
                // åœæ­¢æƒæ
                stopScanner();
                
                // é—œé–‰æ¨¡æ…‹çª—å£
                if (scannerModal) scannerModal.style.display = 'none';
                alert('æ•¸æ“šæˆåŠŸæ¥æ”¶ä¸¦åˆä½µï¼');
            } catch (e) {
                console.error('æ•¸æ“šè§£æå¤±æ•—:', e);
                if (scannerError) {
                    scannerError.textContent = 'ç„¡æ³•è§£ææƒæåˆ°çš„æ•¸æ“š: ' + e.message;
                    scannerError.style.display = 'block';
                }
            }
        }
        
        // é©—è­‰æ•¸æ“šå®Œæ•´æ€§
        function verifyDataIntegrity(payload) {
            // æª¢æŸ¥å¿…å¡«å­—æ®µ
            if (!payload.experimentType || 
                !payload.timestamp || 
                !payload.dataPoints || 
                payload.experimentType !== "wire-resistance") {
                return false;
            }
            
            // æª¢æŸ¥æ•¸æ“šé»æ ¼å¼
            return payload.dataPoints.every(point => 
                typeof point.length === 'number' && 
                typeof point.voltage === 'number' &&
                typeof point.current === 'number' &&
                point.length > 0 &&
                point.voltage > 0 &&
                point.current > 0
            );
        }
        
        // åˆä½µæ¥æ”¶çš„æ•¸æ“š
        function mergeReceivedData(receivedPoints) {
            const mergedData = [...dataPoints];
            let newPointsCount = 0;
            
            // æª¢æŸ¥æ¯å€‹æ¥æ”¶çš„æ•¸æ“šé»æ˜¯å¦å·²å­˜åœ¨
            receivedPoints.forEach(newPoint => {
                const exists = dataPoints.some(point => 
                    Math.abs(point.length - newPoint.length) < 0.01 &&
                    Math.abs(point.voltage - newPoint.voltage) < 0.01 &&
                    Math.abs(point.current - newPoint.current) < 0.01
                );
                
                if (!exists) {
                    mergedData.push(newPoint);
                    newPointsCount++;
                }
            });
            
            // æ›´æ–°æœ¬åœ°æ•¸æ“š
            dataPoints = mergedData;
            
            // æ›´æ–°ç•Œé¢
            updateDataTable();
            updateChart();
            
            // é¡¯ç¤ºçµæœ
            if (newPointsCount > 0) {
                alert(`æˆåŠŸåˆä½µ ${newPointsCount} çµ„æ–°æ•¸æ“šé»ï¼`);
            } else {
                alert('æœªç™¼ç¾æ–°æ•¸æ“šé»ï¼Œæ‰€æœ‰æ¥æ”¶çš„æ•¸æ“šå·²å­˜åœ¨æ–¼æœ¬åœ°');
            }
        }
    </script>
</body>
</html>