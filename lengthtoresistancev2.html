<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç·šé›»é˜»å¯¦é©—æ¢ç©¶ç³»çµ± | æ•¸æ“šå…±äº«ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 15px;
            max-width: 1000px;
            margin: 0 auto;
            padding-bottom: 60px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px 0;
            background: linear-gradient(135deg, #1e5799 0%, #207cca 51%, #2989d8 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 1.4em;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #1e5799;
            display: flex;
            align-items: center;
        }
        
        .card-title::before {
            content: "â€¢";
            margin-right: 8px;
            color: #1e5799;
            font-size: 1.5em;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
        }
        
        .input-field {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-size: 0.85em;
            margin-bottom: 4px;
            color: #555;
        }
        
        input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background: #1e5799;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            background: #1a4a85;
        }
        
        button.secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        button.secondary:hover {
            background: #d0d0d0;
        }
        
        button.danger {
            background: #ff4444;
        }
        
        button.danger:hover {
            background: #e03333;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f0f5ff;
            font-weight: bold;
        }
        
        tr.anomaly td {
            background-color: #ffebee;
        }
        
        .chart-container {
            height: 250px;
            margin-top: 15px;
        }
        
        .prediction-section {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .prediction-inputs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .prediction-results {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .note {
            font-size: 0.8em;
            color: #666;
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .modal-header {
            padding: 15px;
            background: #1e5799;
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .close {
            font-size: 1.5em;
            cursor: pointer;
            padding: 0 5px;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .qrcode-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            min-height: 280px;
        }
        
        #qrcode {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .scanner-container {
            position: relative;
            width: 100%;
            min-height: 300px;
            background: black;
            border-radius: 5px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .steps {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .step {
            display: flex;
            margin-bottom: 10px;
        }
        
        .step-number {
            background: #1e5799;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.8em;
            color: #777;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 15px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #1e5799;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 480px) {
            .input-row {
                flex-direction: column;
            }
            
            button {
                min-width: 100%;
            }
            
            .prediction-inputs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>æ¢ç©¶å°ç·šé•·åº¦å°é›»é˜»çš„å½±éŸ¿</h1>
        <div class="subtitle">ç§‘å­¸å¯¦é©—æ¨¡æ“¬ç³»çµ± | æ•¸æ“šå…±äº«ç‰ˆ</div>
    </div>

    <div class="card">
        <div class="card-title">å¯¦é©—æ­¥é©Ÿ</div>
        <ol style="padding-left: 20px; margin-bottom: 15px;">
            <li style="margin-bottom: 8px;">è¼¸å…¥å°ç·šé•·åº¦ã€é›»æµå’Œé›»å£“å€¼ï¼ˆç³»çµ±æœƒè‡ªå‹•è¨ˆç®—é›»é˜»ï¼‰</li>
            <li style="margin-bottom: 8px;">é»æ“Šã€Œæ·»åŠ æ•¸æ“šé»ã€å°‡æ•¸æ“šæ·»åŠ åˆ°å¯¦é©—è¨˜éŒ„ä¸­</li>
            <li style="margin-bottom: 8px;">é‡è¤‡æ­¥é©Ÿ1-2ï¼Œæ·»åŠ è‡³å°‘5çµ„ä¸åŒé•·åº¦çš„æ•¸æ“š</li>
            <li style="margin-bottom: 8px;">ç³»çµ±æœƒè‡ªå‹•ç¹ªè£½æ•£é»åœ–ä¸¦è¨ˆç®—ç·šæ€§å›æ­¸æ–¹ç¨‹</li>
            <li style="margin-bottom: 8px;">è‹¥æ•¸æ“šé»åé›¢å›æ­¸ç·šéé ï¼Œç³»çµ±æœƒæ¨™è¨˜ç‚ºç•°å¸¸é»ï¼ˆç´…è‰²èƒŒæ™¯ï¼‰</li>
            <li style="margin-bottom: 8px;">é»æ“Šæ•¸æ“šè¡¨ä¸­çš„ã€Œåˆªé™¤ã€æŒ‰éˆ•ï¼Œåˆªé™¤ç•°å¸¸é»</li>
            <li>ä½¿ç”¨é æ¸¬å€è¼¸å…¥æ–°é•·åº¦å’Œé›»å£“ï¼Œé æ¸¬é›»é˜»å’Œé›»æµå€¼</li>
        </ol>
    </div>

    <div class="card">
        <div class="card-title">è¼¸å…¥å¯¦é©—æ•¸æ“š</div>
        <div class="input-group">
            <div class="input-row">
                <div class="input-field">
                    <label for="length">å°ç·šé•·åº¦ (m)</label>
                    <input type="number" id="length" step="0.01" min="0.1" max="10" value="1.00">
                </div>
                <div class="input-field">
                    <label for="current">é›»æµ (A)</label>
                    <input type="number" id="current" step="0.01" min="0.01" max="5" value="0.50">
                </div>
            </div>
            <div class="input-row">
                <div class="input-field">
                    <label for="voltage">é›»å£“ (V)</label>
                    <input type="number" id="voltage" step="0.01" min="0.01" max="20" value="2.50">
                </div>
                <div class="input-field">
                    <label>é›»é˜» (Î©)</label>
                    <input type="text" id="resistance" readonly value="5.00">
                </div>
            </div>
        </div>
        <div class="button-group">
            <button id="add-data"><i>+</i> æ·»åŠ æ•¸æ“šé»</button>
            <button id="clear-data" class="secondary">æ¸…é™¤æ•¸æ“š</button>
            <button id="demo-data" class="secondary">ç¤ºç¯„æ•¸æ“š</button>
            <button id="share-data">åˆ†äº«å¯¦é©—æ•¸æ“š</button>
        </div>
    </div>

    <div class="card">
        <div class="card-title">å¯¦é©—æ•¸æ“š</div>
        <div class="note">ç•¶æ•¸æ“šé»åé›¢å›æ­¸ç·šéé æ™‚ï¼Œç³»çµ±æœƒæ¨™è¨˜ç‚ºç•°å¸¸é»ï¼ˆç´…è‰²èƒŒæ™¯ï¼‰ã€‚é»æ“Šæ•¸æ“šè¡¨ä¸­çš„ã€Œåˆªé™¤ã€æŒ‰éˆ•å¯åˆªé™¤é€™äº›é»ã€‚</div>
        <table id="data-table">
            <thead>
                <tr>
                    <th>å°ç·šé•·åº¦ (m)</th>
                    <th>é›»æµ (A)</th>
                    <th>é›»å£“ (V)</th>
                    <th>é›»é˜» (Î©)</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        
        <div class="chart-container">
            <canvas id="resistance-chart"></canvas>
        </div>
        
        <div class="note" style="margin-top: 10px;">
            å¯¦é©—æ•¸æ“šå›æ­¸ç·š y = <span id="regression-slope">0.00</span>x + <span id="regression-intercept">0.00</span><br>
            æ±ºå®šä¿‚æ•¸ RÂ² = <span id="regression-r2">0.0000</span> ğŸ”®
        </div>
    </div>

    <div class="card">
        <div class="card-title">é æ¸¬æ–°å€¼</div>
        <div class="prediction-section">
            <div class="prediction-inputs">
                <div class="input-field">
                    <label for="predict-length">å°ç·šé•·åº¦ (m)</label>
                    <input type="number" id="predict-length" step="0.01" min="0.1" max="10" value="2.00">
                </div>
                <div class="input-field">
                    <label for="predict-voltage">é›»å£“ (V)</label>
                    <input type="number" id="predict-voltage" step="0.01" min="0.01" max="20" value="5.00">
                </div>
            </div>
            <button id="calculate-prediction" style="width: 100%;">è¨ˆç®—é æ¸¬å€¼</button>
            
            <div class="prediction-results">
                <div>
                    é è¨ˆé›»é˜» (Î©)<br>
                    <span id="predicted-resistance">0.00</span>
                </div>
                <div>
                    é è¨ˆé›»æµ (A)<br>
                    <span id="predicted-current">0.00</span>
                </div>
            </div>
        </div>
        <div class="note">
            æ³¨æ„ï¼š é æ¸¬å€¼åŸºæ–¼ç·šæ€§å›æ­¸æ¨¡å‹è¨ˆç®—ã€‚ç•¶æ•¸æ“šé»æ•¸é‡ä¸è¶³æˆ–åˆ†ä½ˆä¸å‡æ™‚ï¼Œé æ¸¬æº–ç¢ºåº¦å¯èƒ½é™ä½ã€‚
        </div>
    </div>

    <div class="card">
        <div class="card-title">æ•¸æ“šå…±äº«</div>
        
        <div class="card" style="margin-top: 15px; background: #e3f2fd;">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <span style="font-size: 1.5em; margin-right: 10px;">ğŸ“±</span>
                <h3 style="margin: 0; color: #1e5799;">ç”ŸæˆQRç¢¼åˆ†äº«æ•¸æ“š</h3>
            </div>
            <p style="margin-bottom: 15px; line-height: 1.4;">
                é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç”ŸæˆQRç¢¼ï¼Œä½¿ç”¨å¦ä¸€å°è¨­å‚™æƒæå³å¯æ¥æ”¶å¯¦é©—æ•¸æ“šï¼Œç„¡éœ€ç¶²çµ¡é€£æ¥ã€‚
            </p>
            <button id="generate-qr" style="width: 100%; background: #4caf50;">
                ç”ŸæˆQRç¢¼åˆ†äº«æ•¸æ“š
            </button>
        </div>
        
        <div class="card" style="background: #e8f5e9;">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <span style="font-size: 1.5em; margin-right: 10px;">ğŸ“·</span>
                <h3 style="margin: 0; color: #388e3c;">æƒæQRç¢¼æ¥æ”¶æ•¸æ“š</h3>
            </div>
            <p style="margin-bottom: 15px; line-height: 1.4;">
                é»æ“Šä¸‹æ–¹æŒ‰éˆ•æƒæå…¶ä»–è¨­å‚™ç”Ÿæˆçš„QRç¢¼ï¼Œæ¥æ”¶ä¸¦æ•´åˆå¯¦é©—æ•¸æ“šã€‚
            </p>
            <button id="scan-qr" style="width: 100%; background: #388e3c;">
                æƒæQRç¢¼æ¥æ”¶æ•¸æ“š
            </button>
        </div>
    </div>

    <div class="footer">
        å°ç·šé›»é˜»å¯¦é©—æ¢ç©¶ç³»çµ± | åŸºæ–¼æ­å§†å®šå¾‹çš„ç§‘å­¸å¯¦é©—æ¨¡æ“¬ | æ•¸æ“šå…±äº«åŠŸèƒ½
    </div>

    <div id="share-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>ğŸ“± åˆ†äº«å¯¦é©—æ•¸æ“š â¡ï¸ ğŸ“± â¡ï¸</span>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="loading" id="qr-loading">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨ç”ŸæˆQRç¢¼...</div>
                    <div id="qr-message" style="margin-top: 10px;"></div>
                </div>
                <div id="qr-content">
                    <div class="steps">
                        <div class="step">
                            <div class="step-number">1</div>
                            <div>è«‹å¦ä¸€å°è¨­å‚™é»æ“Šã€Œæ¥æ”¶å¯¦é©—æ•¸æ“šã€</div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div>ä½¿ç”¨è©²è¨­å‚™æƒææ­¤QRç¢¼</div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div>æ•¸æ“šå°‡è‡ªå‹•å‚³è¼¸ä¸¦æ•´åˆ</div>
                        </div>
                    </div>
                    
                    <div class="note" style="margin: 15px 0;">
                        æ³¨æ„ï¼š å…©å°è¨­å‚™éœ€åœ¨åŒä¸€ç‰©ç†ä½ç½®ï¼Œä¸”æ¥æ”¶è¨­å‚™éœ€æˆäºˆç›¸æ©Ÿæ¬Šé™ã€‚
                    </div>
                    
                    <div class="qrcode-container">
                        <div id="qrcode"></div>
                    </div>
                    
                    <div class="note" style="margin-top: 15px; text-align: center;">
                        QRç¢¼åŒ…å«æœ€è¿‘20çµ„å¯¦é©—æ•¸æ“šé»<br>
                        è«‹åœ¨5åˆ†é˜å…§å®Œæˆæƒæ
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="scanner-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>ğŸ“· æƒæQRç¢¼æ¥æ”¶æ•¸æ“š ğŸ“± â¡ï¸ ğŸ“±</span>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div>å°‡ç›¸æ©Ÿå°æº–å¦ä¸€å°è¨­å‚™é¡¯ç¤ºçš„QRç¢¼</div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div>ä¿æŒç©©å®šç›´åˆ°è‡ªå‹•è­˜åˆ¥</div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div>æ•¸æ“šå°‡è‡ªå‹•æ•´åˆåˆ°ç•¶å‰å¯¦é©—</div>
                    </div>
                </div>
                
                <div class="note" style="margin: 15px 0;">
                    æ³¨æ„ï¼š éœ€è¦æˆäºˆç›¸æ©Ÿæ¬Šé™ã€‚å¦‚æœç„¡æ³•è­˜åˆ¥ï¼Œè«‹ç¢ºä¿å…‰ç·šå……è¶³ä¸”QRç¢¼å®Œæ•´å¯è¦‹ã€‚
                </div>
                
                <div class="scanner-container" id="reader">
                </div>
                
            </div>
        </div>
    </div>

    <script>
        // æ•¸æ“šå­˜å„²
        let dataPoints = [];
        let chart = null;
        let regression = {
            slope: 0,
            intercept: 0,
            r2: 0
        };
        
        let html5QrCode = null; // æ–°å¢ html5-qrcode å¯¦ä¾‹è®Šæ•¸
        
        // DOMå…ƒç´ 
        const lengthInput = document.getElementById('length');
        const currentInput = document.getElementById('current');
        const voltageInput = document.getElementById('voltage');
        const resistanceInput = document.getElementById('resistance');
        const dataTable = document.getElementById('data-table').getElementsByTagName('tbody')[0];
        const addDataBtn = document.getElementById('add-data');
        const clearDataBtn = document.getElementById('clear-data');
        const demoDataBtn = document.getElementById('demo-data');
        const shareDataBtn = document.getElementById('share-data');
        const generateQrBtn = document.getElementById('generate-qr');
        const scanQrBtn = document.getElementById('scan-qr');
        const calculatePredictionBtn = document.getElementById('calculate-prediction');
        
        // æ¨¡æ…‹çª—å£
        const shareModal = document.getElementById('share-modal');
        const scannerModal = document.getElementById('scanner-modal');
        const closeModalButtons = document.querySelectorAll('.close');
        const qrLoading = document.getElementById('qr-loading');
        const qrContent = document.getElementById('qr-content');
        const qrMessage = document.getElementById('qr-message');
        
        // é æ¸¬ç›¸é—œå…ƒç´ 
        const predictLength = document.getElementById('predict-length');
        const predictVoltage = document.getElementById('predict-voltage');
        const predictedResistance = document.getElementById('predicted-resistance');
        const predictedCurrent = document.getElementById('predicted-current');
        
        // å›æ­¸ç›¸é—œå…ƒç´ 
        const regressionSlope = document.getElementById('regression-slope');
        const regressionIntercept = document.getElementById('regression-intercept');
        const regressionR2 = document.getElementById('regression-r2');
        
        // çµ±ä¸€é—œé–‰æ‰€æœ‰å½ˆè·³è¦–çª—èˆ‡ç›¸æ©Ÿçš„å‡½æ•¸
        function closeAllModals() {
            shareModal.style.display = 'none';
            scannerModal.style.display = 'none';
            
            // å®‰å…¨åœ°åœæ­¢ html5-qrcode ç›¸æ©Ÿ
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => {
                    console.error("ç›¸æ©Ÿåœæ­¢å¤±æ•—:", err);
                });
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è¨ˆç®—é›»é˜»
            function calculateResistance() {
                const current = parseFloat(currentInput.value) || 0;
                const voltage = parseFloat(voltageInput.value) || 0;
                
                if (current > 0) {
                    const resistance = voltage / current;
                    resistanceInput.value = resistance.toFixed(2);
                } else {
                    resistanceInput.value = '0.00';
                }
            }
            
            // æ·»åŠ äº‹ä»¶ç›£è½
            lengthInput.addEventListener('input', calculateResistance);
            currentInput.addEventListener('input', calculateResistance);
            voltageInput.addEventListener('input', calculateResistance);
            
            // æ·»åŠ æ•¸æ“šé»
            addDataBtn.addEventListener('click', function() {
                const length = parseFloat(lengthInput.value);
                const current = parseFloat(currentInput.value);
                const voltage = parseFloat(voltageInput.value);
                
                if (isNaN(length) || isNaN(current) || isNaN(voltage) || length <= 0 || current <= 0 || voltage <= 0) {
                    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ­£æ•¸å€¼');
                    return;
                }
                
                const resistance = voltage / current;
                
                // æ·»åŠ åˆ°æ•¸æ“šé»æ•¸çµ„
                dataPoints.push({
                    length: length,
                    current: current,
                    voltage: voltage,
                    resistance: resistance
                });
                
                // æ›´æ–°è¡¨æ ¼å’Œåœ–è¡¨
                updateDataTable();
                updateChart();
                
                // æ¸…ç©ºè¼¸å…¥
                lengthInput.value = '1.00';
                currentInput.value = '0.50';
                voltageInput.value = '2.50';
                calculateResistance();
            });
            
            // æ¸…é™¤æ•¸æ“š
            clearDataBtn.addEventListener('click', function() {
                if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¯¦é©—æ•¸æ“šå—ï¼Ÿ')) {
                    dataPoints = [];
                    updateDataTable();
                    updateChart();
                }
            });
            
            // æ·»åŠ ç¤ºç¯„æ•¸æ“š
            demoDataBtn.addEventListener('click', function() {
                // æ¸…é™¤ç¾æœ‰æ•¸æ“š
                dataPoints = [];
                
                // æ·»åŠ ç¤ºç¯„æ•¸æ“š
                const lengths = [0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0];
                lengths.forEach(length => {
                    const resistance = length * 2.0; // å‡è¨­é›»é˜»ç‡ç‚º2.0 Î©/m
                    const voltage = 5.0;
                    const current = voltage / resistance;
                    
                    dataPoints.push({
                        length: length,
                        current: current,
                        voltage: voltage,
                        resistance: resistance
                    });
                });
                
                // æ›´æ–°ç•Œé¢
                updateDataTable();
                updateChart();
            });
            
            // ç”ŸæˆQRç¢¼åˆ†äº«
            generateQrBtn.addEventListener('click', generateQRCode);
            shareDataBtn.addEventListener('click', generateQRCode);
            
            // æƒæQRç¢¼
            scanQrBtn.addEventListener('click', startQRScanner);
            
            // è¨ˆç®—é æ¸¬å€¼
            calculatePredictionBtn.addEventListener('click', calculatePrediction);
            
            // é—œé–‰æ¨¡æ…‹çª—å£
            closeModalButtons.forEach(button => {
                button.addEventListener('click', closeAllModals);
            });
            
            // é»æ“Šæ¨¡æ…‹çª—å£å¤–éƒ¨é—œé–‰
            window.addEventListener('click', function(event) {
                if (event.target === shareModal || event.target === scannerModal) {
                    closeAllModals();
                }
            });
            
            // åˆå§‹è¨ˆç®—
            calculateResistance();
            initChart();
        });
        
        // åˆå§‹åŒ–åœ–è¡¨
        function initChart() {
            const ctx = document.getElementById('resistance-chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'å¯¦é©—æ•¸æ“šé»',
                        data: [],
                        backgroundColor: '#1e5799',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }, {
                        label: 'å›æ­¸ç·š',
                        data: [],
                        type: 'line',
                        borderColor: '#ff0000',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0,
                        showLine: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'å°ç·šé•·åº¦ (m)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'é›»é˜» (Î©)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = dataPoints[context.dataIndex];
                                    return [
                                        `é•·åº¦: ${point.length} m`,
                                        `é›»é˜»: ${point.resistance.toFixed(2)} Î©`,
                                        `é›»å£“: ${point.voltage} V`,
                                        `é›»æµ: ${point.current.toFixed(2)} A`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // æ›´æ–°åœ–è¡¨
        function updateChart() {
            if (!chart) return;
            
            // æ›´æ–°æ•¸æ“šé»
            const points = dataPoints.map(point => ({
                x: point.length,
                y: point.resistance
            }));
            
            // è¨ˆç®—å›æ­¸ç·š
            if (dataPoints.length >= 2) {
                const result = calculateLinearRegression(dataPoints);
                regression = result;
                
                // æ›´æ–°å›æ­¸ä¿‚æ•¸é¡¯ç¤º
                regressionSlope.textContent = result.slope.toFixed(2);
                regressionIntercept.textContent = result.intercept.toFixed(2);
                regressionR2.textContent = result.r2.toFixed(4);
                
                // è¨ˆç®—å›æ­¸ç·šæ•¸æ“š
                if (points.length > 0) {
                    const minX = Math.min(...points.map(p => p.x));
                    const maxX = Math.max(...points.map(p => p.x));
                    
                    const regressionLine = [
                        {x: minX, y: result.slope * minX + result.intercept},
                        {x: maxX, y: result.slope * maxX + result.intercept}
                    ];
                    
                    // æ›´æ–°åœ–è¡¨
                    chart.data.datasets[0].data = points;
                    chart.data.datasets[1].data = regressionLine;
                    
                    // æ¨™è¨˜ç•°å¸¸é»
                    markAnomalyPoints(result);
                }
            } else {
                // é‡ç½®å›æ­¸ä¿‚æ•¸
                regressionSlope.textContent = '0.00';
                regressionIntercept.textContent = '0.00';
                regressionR2.textContent = '0.0000';
                
                // åªæ›´æ–°æ•¸æ“šé»
                chart.data.datasets[0].data = points;
                chart.data.datasets[1].data = [];
            }
            
            chart.update();
        }
        
        // æ¨™è¨˜ç•°å¸¸é»
        function markAnomalyPoints(regression) {
            const tableRows = dataTable.querySelectorAll('tr');
            
            tableRows.forEach((row, index) => {
                const point = dataPoints[index];
                if (!point) return;
                
                // è¨ˆç®—é æ¸¬å€¼
                const predictedResistance = regression.slope * point.length + regression.intercept;
                // è¨ˆç®—æ®˜å·®
                const residual = Math.abs(point.resistance - predictedResistance);
                // è¨ˆç®—æ¨™æº–å·®
                const stdDev = calculateStdDev(dataPoints.map(p => 
                    p.resistance - (regression.slope * p.length + regression.intercept)
                ));
                
                // å¦‚æœæ®˜å·®å¤§æ–¼2å€‹æ¨™æº–å·®ï¼Œæ¨™è¨˜ç‚ºç•°å¸¸
                if (stdDev > 0 && residual > 2 * stdDev) {
                    row.classList.add('anomaly');
                } else {
                    row.classList.remove('anomaly');
                }
            });
        }
        
        // è¨ˆç®—æ¨™æº–å·®
        function calculateStdDev(values) {
            const n = values.length;
            if (n <= 1) return 0;
            
            const mean = values.reduce((sum, val) => sum + val, 0) / n;
            const squaredDiffs = values.map(val => Math.pow(val - mean, 2));
            const variance = squaredDiffs.reduce((sum, val) => sum + val, 0) / (n - 1);
            
            return Math.sqrt(variance);
        }
        
        // è¨ˆç®—ç·šæ€§å›æ­¸
        function calculateLinearRegression(points) {
            const n = points.length;
            let sumX = 0;
            let sumY = 0;
            let sumXY = 0;
            let sumXX = 0;
            let sumYY = 0;
            
            points.forEach(point => {
                sumX += point.length;
                sumY += point.resistance;
                sumXY += point.length * point.resistance;
                sumXX += point.length * point.length;
                sumYY += point.resistance * point.resistance;
            });
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            // è¨ˆç®—RÂ²
            const meanY = sumY / n;
            let ssTotal = 0;
            let ssResidual = 0;
            
            points.forEach(point => {
                const predictedY = slope * point.length + intercept;
                ssTotal += Math.pow(point.resistance - meanY, 2);
                ssResidual += Math.pow(point.resistance - predictedY, 2);
            });
            
            const r2 = 1 - (ssResidual / ssTotal);
            
            return {
                slope: slope,
                intercept: intercept,
                r2: r2
            };
        }
        
        // æ›´æ–°æ•¸æ“šè¡¨
        function updateDataTable() {
            // æ¸…ç©ºè¡¨æ ¼
            dataTable.innerHTML = '';
            
            // æ·»åŠ æ•¸æ“šè¡Œ
            dataPoints.forEach((point, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${point.length.toFixed(2)}</td>
                    <td>${point.current.toFixed(2)}</td>
                    <td>${point.voltage.toFixed(2)}</td>
                    <td>${point.resistance.toFixed(2)}</td>
                    <td><button class="danger" data-index="${index}">åˆªé™¤</button></td>
                `;
                
                // æ·»åŠ åˆªé™¤åŠŸèƒ½
                const deleteBtn = row.querySelector('button');
                deleteBtn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    dataPoints.splice(index, 1);
                    updateDataTable();
                    updateChart();
                });
                
                dataTable.appendChild(row);
            });
            
            // å¦‚æœæ²’æœ‰æ•¸æ“šï¼Œé¡¯ç¤ºæç¤ºè¡Œ
            if (dataPoints.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="5" style="text-align: center; padding: 20px;">
                        å°šæœªæ·»åŠ ä»»ä½•æ•¸æ“šé»<br>
                        è«‹è¼¸å…¥å¯¦é©—æ•¸æ“šä¸¦é»æ“Šã€Œæ·»åŠ æ•¸æ“šé»ã€
                    </td>
                `;
                dataTable.appendChild(row);
            }
        }
        
        // è¨ˆç®—é æ¸¬å€¼
        function calculatePrediction() {
            const length = parseFloat(predictLength.value);
            const voltage = parseFloat(predictVoltage.value);
            
            if (isNaN(length) || isNaN(voltage) || length <= 0 || voltage <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ­£æ•¸å€¼');
                return;
            }
            
            // ä½¿ç”¨å›æ­¸æ¨¡å‹é æ¸¬é›»é˜»
            const predictedResistance = regression.slope * length + regression.intercept;
            const predictedCurrent = voltage / predictedResistance;
            
            // æ›´æ–°é¡¯ç¤º
            document.getElementById('predicted-resistance').textContent = predictedResistance.toFixed(2);
            document.getElementById('predicted-current').textContent = predictedCurrent.toFixed(2);
        }
        
        // ç”ŸæˆQRç¢¼
        function generateQRCode() {
            // æª¢æŸ¥æ˜¯å¦æœ‰è¶³å¤ æ•¸æ“š
            if (dataPoints.length === 0) {
                alert('è«‹å…ˆæ·»åŠ è‡³å°‘ä¸€çµ„å¯¦é©—æ•¸æ“š');
                return;
            }
            
            // é¡¯ç¤ºæ¨¡æ…‹çª—å£
            shareModal.style.display = 'block';
            
            // é¡¯ç¤ºåŠ è¼‰ç‹€æ…‹
            qrLoading.style.display = 'block';
            qrContent.style.display = 'none';
            
            // 500mså»¶é²ä»¥ç¢ºä¿UIæ›´æ–°
            setTimeout(() => {
                try {
                    // åªå–æœ€è¿‘20çµ„æ•¸æ“š
                    const recentData = dataPoints.slice(-20);
                    
                    // æ§‹å»ºå¸¶æœ‰å…ƒæ•¸æ“šçš„æ•¸æ“šçµæ§‹
                    const payload = {
                        experimentType: "wire-resistance",
                        timestamp: Date.now(),
                        version: "1.0",
                        deviceInfo: {
                            platform: navigator.platform,
                            userAgent: navigator.userAgent
                        },
                        dataPoints: recentData
                    };
                    
                    // å°‡æ•¸æ“šå£“ç¸®ä»¥é©æ‡‰QRç¢¼å®¹é‡é™åˆ¶
                    const compressedData = LZString.compressToBase64(JSON.stringify(payload));
                    
                    // ç”ŸæˆQRç¢¼
                    const qrCodeContainer = document.getElementById('qrcode');
                    qrCodeContainer.innerHTML = '';
                    
                    new QRCode(qrCodeContainer, {
                        text: compressedData,
                        width: 256,
                        height: 256,
                        correctLevel: QRCode.CorrectLevel.H // é«˜å®¹éŒ¯ç‡
                    });
                    
                    // æ›´æ–°UI
                    qrLoading.style.display = 'none';
                    qrContent.style.display = 'block';
                    
                    // é¡¯ç¤ºæ¶ˆæ¯
                    if (dataPoints.length > 20) {
                        qrMessage.textContent = 'æ³¨æ„ï¼š æ•¸æ“šé‡è¼ƒå¤§ï¼Œå·²è‡ªå‹•é™åˆ¶ç‚ºæœ€è¿‘20çµ„æ•¸æ“šé»ã€‚';
                    } else {
                        qrMessage.textContent = '';
                    }
                } catch (e) {
                    console.error('QRç¢¼ç”Ÿæˆå¤±æ•—:', e);
                    qrLoading.style.display = 'none';
                    alert('ç„¡æ³•ç”ŸæˆQRç¢¼ï¼Œè«‹é‡è©¦');
                }
            }, 500);
        }
        
        // é–‹å§‹ä½¿ç”¨ html5-qrcode æƒæQRç¢¼
        function startQRScanner() {
            // é¡¯ç¤ºæ¨¡æ…‹çª—å£
            scannerModal.style.display = 'block';
            
            // åˆå§‹åŒ– html5-qrcode å¯¦ä¾‹
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }
            
            // è¨­å®šæƒæåƒæ•¸
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };
            
            // å•Ÿå‹•ç›¸æ©Ÿ (å„ªå…ˆä½¿ç”¨å¾Œç½®ç’°å¢ƒé¡é ­)
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                function(decodedText, decodedResult) {
                    // --- æˆåŠŸæƒæè™•ç† ---
                    try {
                        // è§£å£“ç¸®å’Œè§£ææ•¸æ“š
                        const decodedData = LZString.decompressFromBase64(decodedText);
                        const payload = JSON.parse(decodedData);
                        
                        // é©—è­‰æ•¸æ“šæ ¼å¼
                        if (!verifyDataIntegrity(payload)) {
                            alert('æƒæåˆ°çš„QRç¢¼æ ¼å¼ç„¡æ•ˆæˆ–ä¸å±¬æ–¼é›»é˜»å¯¦é©—æ•¸æ“š');
                            return;
                        }
                        
                        // é—œé–‰ç›¸æ©Ÿå’Œæ¨¡æ…‹çª—å£
                        closeAllModals();
                        
                        // åˆä½µæ•¸æ“š
                        mergeReceivedData(payload.dataPoints);
                        
                    } catch (e) {
                        console.error('æ•¸æ“šè§£æå¤±æ•—:', e);
                        // è§£æå¤±æ•—ä¸é—œé–‰ç›¸æ©Ÿï¼Œè®“ä½¿ç”¨è€…å¯ä»¥ç¹¼çºŒå°ç„¦
                    }
                },
                function(errorMessage) {
                    // æƒæéç¨‹ä¸­æœªæ‰¾åˆ°QRç¢¼ï¼ˆå±¬æ­£å¸¸ç¾åƒï¼Œè‡ªå‹•å¿½ç•¥ï¼‰
                }
            ).catch(function(err) {
                console.error('ç›¸æ©Ÿè¨ªå•å¤±æ•—:', err);
                
                let errorMessage = 'ç„¡æ³•è¨ªå•ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥ï¼š\n';
                errorMessage += 'â€¢ æ‚¨æ˜¯å¦å…è¨±äº†ç€è¦½å™¨çš„ç›¸æ©Ÿæ¬Šé™\n';
                errorMessage += 'â€¢ è«‹ç¢ºä¿ç¶²ç«™åœ¨ HTTPS ç’°å¢ƒä¸‹é‹è¡Œ\n';
                errorMessage += 'â€¢ æ‚¨çš„è¨­å‚™ï¼ˆå¦‚ Surface / iPadï¼‰æ˜¯å¦æ”¯æ´æ‰€é¸é¡é ­\n\n';
                errorMessage += 'éŒ¯èª¤è©³æƒ…: ' + err;
                
                alert(errorMessage);
                scannerModal.style.display = 'none';
            });
        }
        
        // é©—è­‰æ•¸æ“šå®Œæ•´æ€§
        function verifyDataIntegrity(payload) {
            // æª¢æŸ¥å¿…å¡«å­—æ®µ
            if (!payload.experimentType || 
                !payload.timestamp || 
                !payload.dataPoints || 
                payload.experimentType !== "wire-resistance") {
                return false;
            }
            
            // æª¢æŸ¥æ•¸æ“šé»æ ¼å¼
            return payload.dataPoints.every(point => 
                typeof point.length === 'number' && 
                typeof point.voltage === 'number' &&
                typeof point.current === 'number' &&
                point.length > 0 &&
                point.voltage > 0 &&
                point.current > 0
            );
        }
        
        // åˆä½µæ¥æ”¶çš„æ•¸æ“š
        function mergeReceivedData(receivedPoints) {
            const mergedData = [...dataPoints];
            let newPointsCount = 0;
            
            // æª¢æŸ¥æ¯å€‹æ¥æ”¶çš„æ•¸æ“šé»æ˜¯å¦å·²å­˜åœ¨
            receivedPoints.forEach(newPoint => {
                const exists = dataPoints.some(point => 
                    Math.abs(point.length - newPoint.length) < 0.01 &&
                    Math.abs(point.voltage - newPoint.voltage) < 0.01 &&
                    Math.abs(point.current - newPoint.current) < 0.01
                );
                
                if (!exists) {
                    mergedData.push(newPoint);
                    newPointsCount++;
                }
            });
            
            // æ›´æ–°æœ¬åœ°æ•¸æ“š
            dataPoints = mergedData;
            
            // æ›´æ–°ç•Œé¢
            updateDataTable();
            updateChart();
            
            // é¡¯ç¤ºçµæœ
            if (newPointsCount > 0) {
                alert(`æˆåŠŸåˆä½µ ${newPointsCount} çµ„æ–°æ•¸æ“šé»ï¼`);
            } else {
                alert('æœªç™¼ç¾æ–°æ•¸æ“šé»ï¼Œæ‰€æœ‰æ¥æ”¶çš„æ•¸æ“šå·²å­˜åœ¨æ–¼æœ¬åœ°');
            }
        }
    </script>
</body>
</html>